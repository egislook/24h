<comp-coins>

  <div class="md-dp:flx ai:c mdx-p-t:20px">
    <div class="p:10px c:black200 md-m-l:30px ps:rl mdx-ta:r">
      <h1 class="p:0 fs:200pc ls:2px fw:300 lh:0.8">coinmarks</h1><small class="fs:60pc c:black200 ps:ab r,t:0 m:2px">v {opts.version}</small>
      <p class="fs:90pc fw:600 c:prim">what can be built in 24h</p>
    </div>

    <div class="md-p-t:40px p-b:10px m-r:0">

      <div class="p:7px-15px_span m:2px_span bg:black_span c:white ta:r fs:90pc crs:pt_span">
        <span title="hide trash coins" onclick={handleClickTrash} class="ts:bg {
          'bg:black c:white':   trash,
          'bg:silver c:black':  !trash
        }">
          <i class="fu-funnel ts:tf fs:90pc {'scy:1n': !trash}" />
          vol > 0.4kk
        </span>
        
        <span each={filter in filters} onclick={handleFilterRemove}>{filter}</span>
        <span class="bg:white-! p:10px mnw:150px c:black" contenteditable="true" onkeydown={handleFilterAdd} placeholder="filter"></span>
      </div>
      <div class="ta:r fs:80pc p:5px-10px c:grey">
        visible {coins.length} / {opts.coins.length} coins
      </div>

      <div class="fs:90pc m-tr:5px m:2px_a ta:r">
        <a onclick={handleClickSorter(sorter, index)} each={sorter, index in sorters} class="p:7px-15px-7px-10px ts:bg {
          'bg:black c:white':   sorter.active,
          'bg:silver c:black':  !sorter.active
        }">
          <i class="fu-sort ts:tf {'scy:1n': sorter.active > 0}" />
          {sorter.name}
        </a>
        
      </div>

    </div>
  </div>

  <div class="p-b:20px">
    <a href="/{coin.symbol}" each={coin, i in coins}
      if={i < showMax}
      key="symbol"
      class="dp:ib p:20px bs:1 m:5px bg:white mnw:200px smx-mnw:46pc hv-bs:2 ts:bs fs:80pc ps:rl ts:all">
      <img class="dp:ib w:25px m-b:5px" src="{coin.logo}" /><br/>
      { coin.name.substring( 0, maxLength ) }
      <span class="r,t:0 p:5px ps:ab fs:80pc">
        <strong class="bd-c:silver800 bd-w:1px p:1px-3px br:2px" title={opts.ago(coin.listed)}>{coin.stage}</strong>
        {coin.symbol}
      </span>
      <span if={coin.stats} class="l,t:0 p:5px ps:ab fs:80pc fw:600">
        {btc && coin.stats.price.btc != 1 ? coin.stats.price.sat : coin.stats.price.usd}
        <strong class="{'c:green': coin.stats.up, 'c:red': !coin.stats.up}">{coin.stats.change.day}%</strong>
      </span>
      <span class="l,b:0 p:5px ps:ab fs:80pc" title="volume">{coin.stats.shortVolume}</span>
      <span class="r,b:0 p:5px ps:ab fs:80pc" title="supply">{coin.stats.shortSupply} ({coin.stats.estimated})</span>

    </a>
  </div>

  <a if={showMax < coins.length} class="fu-plus p:20px bg:prim c:white br:50pc-50pc-0-50pc ps:fx r,b:0 bs:2 m:10px" onclick={handleShowMore}>
    <span class="ps:ab b,r:0 p:4px bg:white c:black mnw,mnh:15px fw:600 fs:60pc br:7px-0-0 ff:Questrial">
      {coins.length - showMax}
    </span>
  </a>

  <a onclick={handleClickCurrencer} class="c:white p:10px-15px br:0-50pc-50pc-0 ps:fx l,t:0 m-t:50px hv-p-l:20px ts:all bs:2 {
    'bg:orange':  btc,
    'bg:prim':   !btc
  }">{btc ? 'à¸¿': '$'}</a>

  <script>
    this.maxLength      = 15;
    this.showMax        = opts.showMax || 36;
    this.showMaxMarkets = opts.showMaxMarkets || 3;
    this.btc        = true;
    this.trash      = true;
    this.filters    = [];
    this.sorters    = [
      { name: 'rank',   key: 'stats.cap', active: 1 },
      { name: 'volume', key: 'stats.volume', active: 0 },
      { name: 'change', key: 'stats.change.day', active: 0 },
      { name: 'price',  key: 'stats.price.sat', active: 0 },
      { name: 'supply', key: 'stats.supply', active: 0 },
      { name: 'listed', key: 'listed', active: 0 },
      { name: 'symbol', key: 'symbol', active: 0 },
      { name: 'name',   key: 'name', active: 0 },
    ];

    this.coins = sortCoins.bind(this)(opts.coins, this.sorters) || filterCoins(opts.coins, this.filters);
    
    // this.on('update', () => {
    //   console.log('update');
    //   requestAnimationFrame( () => {
    //     console.log('before animation');
    //   });
    // })

    this.handleClickCurrencer = (e) => (this.btc = !this.btc);
    this.handleClickTrash     = (e) => {
      this.trash = !this.trash;
      this.coins = sortCoins.bind(this)(this.opts.coins, this.sorters);
      //console.log(this.coins);
    }

    this.handleClickSorter = (sorter, index) => (e) => {
      e.preventUpdate = true;
      this.sorters.map( (s, i) => index !== i && (s.active = 0) || s);
      sorter.active = sorter.active > 0 ? -1 : 1;
      // this.sorters.splice(index, 1);
      // this.sorters.unshift(sorter);
      this.update({ coins: sortCoins.bind(this)(filterCoins(opts.coins, this.filters), this.sorters) });
      //console.log(sorter, index, this);
    }

    this.handleFilterAdd = (e) => {
      let val = e.target.textContent;
      if(e.keyCode === 13 && val && val.length > 1){
        this.filters.push(val.toLowerCase());
        e.target.textContent = '';
        this.update({ coins: filterCoins(this.coins, this.filters) });
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }

    this.handleFilterRemove = (e) => {
      e.preventUpdate = true;
      let val = e.target.textContent;
      this.filters = this.filters.filter(filter => filter !== val);
      this.update({ coins: sortCoins.bind(this)(filterCoins(opts.coins, this.filters), this.sorters) })
    }

    this.handleShowMore = (e) => {
      this.showMax = this.showMax * 2;
    }

    function sortCoins(coins, sorters){
      if(this.trash)
        coins = coins.filter(coin => coin.stats && !coin.stats.trash)
      return coins.sort( (a, b) => {
        return sorters.filter(sorter => sorter.active)
          .map(sorter => {
            let first   = sorter.key.split('.').reduce( (o, i) => o[i], a);
            let second  = sorter.key.split('.').reduce( (o, i) => o[i], b);
            return sorter.active < 0
              ? typeof first === 'string'  ? first.localeCompare(second) : first - second
              : typeof second === 'string' ? second.localeCompare(first) : second - first
          }).find(val => val !== 0);
      })
    }

    function filterCoins(coins, filters){
      return coins.filter(coin => 
        coin.tags.filter(filter => filters.includes(filter)).length === filters.length
      );
    }

  </script>
</comp-coins>
